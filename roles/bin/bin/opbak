#!/bin/bash

# NOTE: I've renamed/deprecated this command because it was interfering with the
# ansible 1password lookup and I don't use it much outisde of ansible anyways

# This function wraps the 'op' function with a simple way of storing the
# token in a file and checking if it is valid before running the actual
# command. This lets you share tokens across sessions

# Get a list of all op accounts
accounts=$(jq -r '.accounts[].shorthand' <~/.op/config)

# Export all op sessions
for account in $accounts; do
  if [ -f "$HOME/.op/token-${account}" ]; then
    acct_export="OP_SESSION_${account}"
    export "$acct_export"="$(cat "$HOME/.op/token-${account}")"
  fi
done

# Modify signin to write token to ~/.op
if [ "$1" = "signin" ]; then
  shift
  /usr/local/bin/op signin "$@" --output=raw >"$HOME/.op/token-$1"
else
  /usr/local/bin/op "$@"
fi
